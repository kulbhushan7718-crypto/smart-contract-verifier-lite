const express = require("express");
const fetch = require("node-fetch");

const app = express();
const port = process.env.PORT || 8080;

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Frontend page
app.get("/", (req, res) => {
  res.send(`
    <h1>Smart Contract Verifier</h1>
    <input id="contract" placeholder="Paste contract address" />
    <button onclick="checkContract()">Check</button>
    <p id="result"></p>

    <script>
      async function checkContract() {
        let address = document.getElementById("contract").value;

        let response = await fetch("/check?address=" + address);
        let data = await response.json();

        document.getElementById("result").innerText = data.result;
      }
    </script>
  `);
});

// API
app.get("/check", async (req, res) => {
  try {
    const address = req.query.address;

    const response = await fetch(
      \`https://api.bscscan.com/api?module=contract&action=getsourcecode&address=\${address}&apikey=YOUR_API_KEY\`
    );

    const data = await response.json();

    if (!data.result || !data.result[0]) {
      return res.json({ result: "Invalid Contract" });
    }

    const source = data.result[0].SourceCode;

    let risk = 0;

    if (source.includes("mint(")) risk += 30;
    if (source.includes("blacklist")) risk += 30;
    if (source.includes("owner")) risk += 20;

    let result = "Low Risk";
    if (risk >= 60) result = "High Risk";
    else if (risk >= 30) result = "Medium Risk";

    res.json({ result });

  } catch (error) {
    res.json({ result: "Error checking contract" });
  }
});

app.listen(port, () => {
  console.log("Server running on port", port);
});
